stages:
  - test
  - docker

cache:
  directories:
  - cache
  
jobs:
  include:
    # Run tests for the Python code
    - language: python
      python: 3.8
      script:
        - python -m unittest python_runner/tests/runner_test.py

    # Run tests for Groovy
    - language: groovy
      before_script:
        - ./gradlew assemble
      script:
        - ./gradlew test

    # Generate docker images (only if modified)
    - stage: docker base
      env: IMAGE=base
    - stage: docker with tools
      env: IMAGE=standard

language: minimal
before_install:
  - |
    count=`git diff --name-only $TRAVIS_COMMIT_RANGE | sort -u | uniq | grep docker_images | wc -l`
    if [ $count -ne 0 ]
    then
      echo "Build docker images"
    else
      echo "No docker image to build"
      travis_terminate 0
    fi
before_script:
  - docker load -i cache/images.tar || true
script:
  - echo "Building docker image $IMAGE"
  - docker build -t travis-ci-$IMAGE docker_images/$IMAGE
  - docker images
  - docker tag travis-ci-$IMAGE conanio/tests-$IMAGE
before_cache:
  - docker save -o cache/images.tar $(docker images -a -q)